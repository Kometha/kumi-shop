<div class="inventory-container">
  <!-- Search and Filters Bar -->
  <div class="search-filters-container mb-6">
    <div
      class="flex items-center gap-4 bg-white p-4 rounded-lg shadow-sm border border-gray-200"
    >
      <!-- Search Input -->
      <div class="flex-1 relative">
        <i
          class="pi pi-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"
        ></i>
        <input
          type="text"
          [(ngModel)]="searchValue"
          (ngModelChange)="applyFilters()"
          placeholder="Buscar productos..."
          class="w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        />
      </div>

      <!-- Filter Tabs -->
      <div class="flex items-center gap-2">
        <button
          (click)="activeFilter = 'todos'; applyFilters()"
          [class.active]="activeFilter === 'todos'"
          class="filter-tab px-4 py-2 rounded-lg font-medium text-sm transition-all"
          [ngClass]="{
            'bg-gray-900 text-white': activeFilter === 'todos',
            'bg-gray-100 text-gray-700 hover:bg-gray-200':
              activeFilter !== 'todos'
          }"
        >
          Todos
        </button>
      </div>
    </div>
  </div>

  <!-- Actions Bar -->
  <div class="flex justify-between items-center mb-4">
    <p class="text-gray-600">
      Mostrando
      <span class="font-semibold">{{ getFilteredProductsCount() }}</span>
      productos
    </p>
    <div class="flex gap-2">
      <button
        pButton
        label="Exportar"
        icon="pi pi-download"
        class="p-button-outlined"
        (click)="showExportDialog()"
      ></button>
      <button
        pButton
        label="Nuevo Producto"
        icon="pi pi-plus"
        (click)="showAddProductModal()"
      ></button>
    </div>
  </div>

  <!-- Table -->
  <div
    class="table-container bg-white rounded-lg shadow-sm border border-gray-200"
  >
    <p-toast></p-toast>
    <p-table
      [value]="filteredProducts"
      [paginator]="true"
      [rows]="10"
      [showCurrentPageReport]="true"
      [loading]="loading"
      currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} productos"
      [rowsPerPageOptions]="[10, 25, 50]"
      [globalFilterFields]="['producto', 'codigo', 'categoria']"
      styleClass="p-datatable-gridlines"
    >
      <ng-template pTemplate="header">
        <tr>
          <th style="width: 80px">Imagen</th>
          <th>Producto</th>
          <th style="width: 80px" class="text-center">Stock</th>
          <th style="width: 120px" class="text-right">Costo</th>
          <th style="width: 120px" class="text-right">Precio Venta</th>
          <th style="width: 120px" class="text-center">Margen (%)</th>
          <th style="width: 120px" class="text-center">Estado</th>
          <th style="width: 100px" class="text-center">Acciones</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-product>
        <tr>
          <!-- Imagen -->
          <td>
            <p-image
              [src]="product.imagen"
              [preview]="true"
              [alt]="product.producto"
              width="60"
              height="60"
              styleClass="product-image-preview"
              [style]="{ 'object-fit': 'cover', 'border-radius': '4px' }">
            </p-image>
          </td>

          <!-- Producto -->
          <td class="font-medium">{{ product.producto }}</td>

          <!-- Stock -->
          <td class="text-center font-semibold">{{ product.stock }}</td>

          <!-- Costo -->
          <td class="text-right font-mono">
            {{ formatCurrency(product.costo) }}
          </td>

          <!-- Precio -->
          <td class="text-right font-mono font-semibold">
            {{ formatCurrency(product.precio) }}
          </td>

          <!-- Margen -->
          <td class="text-center">{{ formatMargin(product.margen) }}%</td>

          <!-- Estado -->
          <td class="text-center">
            <p-tag
              [value]="getEstadoLabel(product.estado)"
              [severity]="getEstadoSeverity(product.estado)"
              [rounded]="true"
            >
            </p-tag>
          </td>

          <!-- Acciones -->
          <td class="text-center">
            <button
              pButton
              type="button"
              icon="pi pi-pencil"
              class="p-button-rounded p-button-text p-button-sm mr-2"
            ></button>
            <button
              pButton
              type="button"
              icon="pi pi-trash"
              class="p-button-rounded p-button-text p-button-danger p-button-sm"
              (click)="confirmDelete(product)"
              [disabled]="loading"
              pTooltip="Eliminar producto"
              tooltipPosition="top">
            </button>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="10" class="text-center py-8">
            <i class="pi pi-inbox text-4xl text-gray-400 mb-3 block"></i>
            <p class="text-gray-500">No se encontraron productos</p>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>

<!-- Modal para agregar producto -->
<p-dialog
  [(visible)]="displayAddProductModal"
  [modal]="true"
  [style]="{ width: '50vw', minWidth: '600px', maxHeight: '90vh' }"
  [breakpoints]="{ '1024px': '75vw', '640px': '95vw' }"
  [draggable]="false"
  [resizable]="false"
  [closable]="true"
  [showHeader]="true"
  header="Agregar Nuevo Producto"
  (onHide)="hideAddProductModal()"
>
  <app-add-product-modal
    (close)="hideAddProductModal()"
    (productCreated)="onProductCreated()">
  </app-add-product-modal>
</p-dialog>

<!-- Modal para exportar -->
<p-dialog
  [(visible)]="displayExportDialog"
  [modal]="true"
  [style]="{ width: '500px', maxHeight: '80vh' }"
  [breakpoints]="{ '1024px': '75vw', '640px': '95vw' }"
  [draggable]="false"
  [resizable]="false"
  [closable]="true"
  [showHeader]="false"
  (onHide)="hideExportDialog()"
>
  <app-export-dialog [products]="filteredProducts" (close)="hideExportDialog()">
  </app-export-dialog>
</p-dialog>

<!-- Modal de confirmación para eliminar producto -->
<p-dialog
  [(visible)]="displayDeleteConfirmDialog"
  [modal]="true"
  [style]="{ width: 'auto', padding: '1rem' }"
  [draggable]="false"
  [resizable]="false"
  [closable]="true"
  [showHeader]="true"
  header="Confirmar Eliminación"
  (onHide)="cancelDelete()">
  <div class="flex flex-column align-items-center gap-4 py-4">
    <div class="text-center">
      <h3 class="text-xl font-semibold mb-2">¿Estás seguro?</h3>
      <p class="text-gray-600">
        ¿Deseas eliminar el producto
        <strong>{{ productToDelete?.producto }}</strong>?
      </p>
    </div>
  </div>
  <ng-template pTemplate="footer">
    <button
      pButton
      type="button"
      label="Cancelar"
      class="p-button-text"
      (click)="cancelDelete()"
      [disabled]="deleting">
    </button>
    <button
      pButton
      type="button"
      label="Sí, eliminar"
      class="p-button-danger"
      (click)="deleteProduct()"
      [loading]="deleting"
      [disabled]="deleting">
    </button>
  </ng-template>
</p-dialog>

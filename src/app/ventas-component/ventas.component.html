<p-toast></p-toast>

<div class="inventory-container p-6">
  <h2 class="text-2xl font-semibold text-gray-800 mb-4">Gesti√≥n de Ventas</h2>

  <!-- Search and Filters Bar -->
  <div class="search-filters-container mb-6">
    <div
      class="flex items-center gap-4 bg-white p-4 rounded-lg shadow-sm border border-gray-200"
    >
      <!-- Search Input -->
      <div class="flex-1 relative">
        <i
          class="pi pi-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"
        ></i>
        <input
          type="text"
          [(ngModel)]="searchValue"
          (ngModelChange)="applyFilters()"
          placeholder="Buscar ventas..."
          class="w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        />
      </div>

      <!-- Filter Tabs -->
      <div class="flex items-center gap-2">
        <button
          (click)="applyFilters()"
          class="filter-tab px-4 py-2 rounded-lg font-medium text-sm transition-all bg-gray-900 text-white"
        >
          Todos
        </button>
      </div>
    </div>
  </div>

  <!-- Actions Bar -->
  <div class="flex justify-between items-center mb-4">
    <p class="text-gray-600">
      Mostrando
      <span class="font-semibold">{{ getFilteredVentasCount() }}</span>
      ventas
    </p>
    <div class="flex gap-2">
      <!-- <button
        pButton
        label="Exportar"
        icon="pi pi-download"
        class="p-button-outlined"
      ></button> -->
      <button
        pButton
        label="Nueva Venta"
        icon="pi pi-plus"
        (click)="showNuevaVentaModal()"
      ></button>
    </div>
  </div>

  <!-- Table -->
  <div
    class="table-container bg-white rounded-lg shadow-sm border border-gray-200"
    style="overflow: visible;"
  >
    <p-table
      [value]="filteredVentas"
      [paginator]="true"
      [rows]="10"
      [showCurrentPageReport]="true"
      [loading]="loadingVentas"
      currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} ventas"
      [rowsPerPageOptions]="[10, 25, 50]"
      styleClass="p-datatable-gridlines"
    >
      <ng-template pTemplate="header">
        <tr>
          <th>Cliente</th>
          <th>Pedido</th>
          <th>Canal</th>
          <th>Fecha</th>
          <th style="width: 120px" class="text-right">Total (L.)</th>
          <th style="width: 120px" class="text-center">Estado</th>
          <th style="width: 100px" class="text-center">Acciones</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-venta>
        <tr>
          <!-- Cliente -->
          <td class="font-medium">{{ venta.cliente || '-' }}</td>

          <!-- Pedido -->
          <td>{{ venta.codigopedido || '-' }}</td>

          <!-- Canal -->
          <td>{{ venta.canal || '-' }}</td>

          <!-- Fecha -->
          <td>{{ formatDate(venta.fecha) }}</td>

          <!-- Total (L.) -->
          <td class="text-right font-mono font-semibold">
            {{ venta.total ? formatCurrency(venta.total) : '-' }}
          </td>

          <!-- Estado -->
          <td class="text-center">
            <p-tag
              [value]="getEstadoLabel(venta.estado || 'pendiente')"
              [severity]="getEstadoSeverity(venta.estado || 'pendiente')"
              [rounded]="true"
            >
            </p-tag>
          </td>

          <!-- Acciones -->
          <td class="text-center">
            <button
              pButton
              type="button"
              icon="pi pi-eye"
              class="p-button-rounded p-button-text p-button-sm mr-2"
              pTooltip="Ver detalles"
              tooltipPosition="top"
              (click)="verDetallesPedido(venta)"
            ></button>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="7" class="text-center py-8">
            <i class="pi pi-inbox text-4xl text-gray-400 mb-3 block"></i>
            <p class="text-gray-500">No se encontraron ventas</p>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>

<!-- Modal para nueva venta -->
<p-dialog
  [(visible)]="displayNuevaVentaModal"
  [modal]="true"
  [style]="{ width: '50vw', minWidth: '600px', maxHeight: '90vh' }"
  [breakpoints]="{ '1024px': '75vw', '640px': '95vw' }"
  [draggable]="false"
  [resizable]="false"
  [closable]="true"
  [showHeader]="true"
  header="Nueva Venta"
>
  <app-nueva-venta-modal
    #nuevaVentaModal
    [(visible)]="displayNuevaVentaModal"
    (ventaGuardada)="onVentaGuardada()"
    (abrirSeleccionProductos)="onAbrirSeleccionProductos()"
  ></app-nueva-venta-modal>
</p-dialog>

<!-- Modal para seleccionar productos -->
<p-dialog
  [(visible)]="displaySeleccionarProductosModal"
  [modal]="true"
  [style]="{ width: '60vw', minWidth: '700px', maxHeight: '90vh' }"
  [breakpoints]="{ '1024px': '85vw', '640px': '95vw' }"
  [draggable]="false"
  [resizable]="false"
  [closable]="true"
  [showHeader]="true"
  header="Seleccionar Productos"
>
  <app-seleccionar-productos-modal
    [(visible)]="displaySeleccionarProductosModal"
    [productosDisponibles]="productosDisponibles"
    (productosSeleccionados)="onProductosSeleccionados($event)"
  ></app-seleccionar-productos-modal>
</p-dialog>

<!-- Modal para ver detalles del pedido -->
<p-dialog
  [(visible)]="displayDetallePedidoModal"
  [modal]="true"
  [style]="{ width: '70vw', minWidth: '800px', maxHeight: '90vh' }"
  [breakpoints]="{ '1024px': '85vw', '640px': '95vw' }"
  [draggable]="false"
  [resizable]="false"
  [closable]="true"
  [showHeader]="true"
  header="Detalles del Pedido"
  (onHide)="onDetallePedidoModalHide()"
>
  <app-detalle-pedido-modal
    [(visible)]="displayDetallePedidoModal"
    [pedidoId]="pedidoIdSeleccionado"
  ></app-detalle-pedido-modal>
</p-dialog>

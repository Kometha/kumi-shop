<p-toast></p-toast>

<div class="inventory-container p-6">
  <h2 class="text-2xl font-semibold text-gray-800 mb-4">Gestión de Ventas</h2>

  <!-- Search and Filters Bar -->
  <div class="search-filters-container mb-6">
    <div
      class="flex items-center gap-4 bg-white p-4 rounded-lg shadow-sm border border-gray-200"
    >
      <!-- Search Input -->
      <div class="flex-1 relative">
        <i
          class="pi pi-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"
        ></i>
        <input
          type="text"
          [(ngModel)]="searchValue"
          (ngModelChange)="applyFilters()"
          placeholder="Buscar ventas..."
          class="w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
        />
      </div>

      <!-- Filter Tabs -->
      <div class="flex items-center gap-2">
        <button
          (click)="applyFilters()"
          class="filter-tab px-4 py-2 rounded-lg font-medium text-sm transition-all bg-gray-900 text-white"
        >
          Todos
        </button>
      </div>
    </div>
  </div>

  <!-- Actions Bar -->
  <div class="flex justify-between items-center mb-4">
    <p class="text-gray-600">
      Mostrando
      <span class="font-semibold">{{ getFilteredVentasCount() }}</span>
      ventas
    </p>
    <div class="flex gap-2">
      <!-- <button
        pButton
        label="Exportar"
        icon="pi pi-download"
        class="p-button-outlined"
      ></button> -->
      <button
        pButton
        label="Nueva Venta"
        icon="pi pi-plus"
        (click)="showNuevaVentaModal()"
      ></button>
    </div>
  </div>

  <!-- Table -->
  <div
    class="table-container bg-white rounded-lg shadow-sm border border-gray-200"
    style="overflow: visible;"
  >
    <p-table
      [value]="filteredVentas"
      [paginator]="true"
      [rows]="10"
      [showCurrentPageReport]="true"
      [loading]="loading"
      currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} ventas"
      [rowsPerPageOptions]="[10, 25, 50]"
      styleClass="p-datatable-gridlines"
    >
      <ng-template pTemplate="header">
        <tr>
          <th>Cliente</th>
          <th>Pedido</th>
          <th>Canal</th>
          <th>Fecha</th>
          <th style="width: 120px" class="text-right">Total (L.)</th>
          <th style="width: 120px" class="text-center">Estado</th>
          <th style="width: 100px" class="text-center">Acciones</th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-venta>
        <tr>
          <!-- Cliente -->
          <td class="font-medium">{{ venta.cliente || '-' }}</td>

          <!-- Pedido -->
          <td>{{ venta.pedido || '-' }}</td>

          <!-- Canal -->
          <td>{{ venta.canal || '-' }}</td>

          <!-- Fecha -->
          <td>{{ venta.fecha || '-' }}</td>

          <!-- Total (L.) -->
          <td class="text-right font-mono font-semibold">
            {{ venta.total ? formatCurrency(venta.total) : '-' }}
          </td>

          <!-- Estado -->
          <td class="text-center">
            <p-tag
              [value]="getEstadoLabel(venta.estado || 'pendiente')"
              [severity]="getEstadoSeverity(venta.estado || 'pendiente')"
              [rounded]="true"
            >
            </p-tag>
          </td>

          <!-- Acciones -->
          <td class="text-center">
            <button
              pButton
              type="button"
              icon="pi pi-eye"
              class="p-button-rounded p-button-text p-button-sm mr-2"
              [disabled]="loading"
              pTooltip="Ver detalles"
              tooltipPosition="top"
            ></button>
            <button
              pButton
              type="button"
              icon="pi pi-pencil"
              class="p-button-rounded p-button-text p-button-sm mr-2"
              [disabled]="loading"
              pTooltip="Editar venta"
              tooltipPosition="top"
            ></button>
            <button
              pButton
              type="button"
              icon="pi pi-trash"
              class="p-button-rounded p-button-text p-button-danger p-button-sm"
              [disabled]="loading"
              pTooltip="Eliminar venta"
              tooltipPosition="top"
            ></button>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="7" class="text-center py-8">
            <i class="pi pi-inbox text-4xl text-gray-400 mb-3 block"></i>
            <p class="text-gray-500">No se encontraron ventas</p>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>

<!-- Modal para nueva venta -->
<p-dialog
  [(visible)]="displayNuevaVentaModal"
  [modal]="true"
  [style]="{ width: '50vw', minWidth: '600px', maxHeight: '90vh' }"
  [breakpoints]="{ '1024px': '75vw', '640px': '95vw' }"
  [draggable]="false"
  [resizable]="false"
  [closable]="true"
  [showHeader]="true"
  header="Nueva Venta"
  (onHide)="hideNuevaVentaModal()"
>
  <div class="nueva-venta-modal">
    <!-- Descripción -->
    <div class="modal-description mb-6">
      <p class="text-sm text-gray-600">Completa la información de la venta</p>
    </div>

    <!-- Información del Cliente -->
    <div class="section mb-6">
      <h3 class="section-title text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">
        INFORMACIÓN DEL CLIENTE
      </h3>

      <div class="grid grid-cols-2 gap-4">
        <div class="form-group">
          <label class="form-label">Nombre del Cliente *</label>
          <input
            type="text"
            pInputText
            [(ngModel)]="nuevaVenta.nombreCliente"
            placeholder="Ej: Juan Pérez"
            class="w-full"
          />
        </div>

        <div class="form-group">
          <label class="form-label">Número de Teléfono *</label>
          <input
            type="text"
            pInputText
            [(ngModel)]="nuevaVenta.telefonoCliente"
            placeholder="Ej: +504 9999-9999"
            class="w-full"
          />
        </div>
      </div>
    </div>

    <!-- Información del Pedido -->
    <div class="section mb-6">
      <h3 class="section-title text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">
        INFORMACIÓN DEL PEDIDO
      </h3>

      <div class="grid grid-cols-2 gap-4">
        <div class="form-group">
          <label class="form-label">Canal *</label>
          <p-dropdown
            [(ngModel)]="nuevaVenta.canal"
            [options]="canales"
            optionLabel="nombre"
            optionValue="id"
            placeholder="Seleccione un canal"
            [loading]="loadingCanales"
            [style]="{'width':'100%'}"
          >
            <ng-template let-canal pTemplate="item">
              <div class="flex items-center gap-2">
                @if (canal.url_icono) {
                  <img [src]="canal.url_icono" [alt]="canal.nombre" class="w-5 h-5" />
                }
                <span>{{ canal.nombre }}</span>
              </div>
            </ng-template>
          </p-dropdown>
        </div>

        <div class="form-group">
          <label class="form-label">Estado *</label>
          <p-dropdown
            [(ngModel)]="nuevaVenta.estado"
            [options]="estados"
            optionLabel="nombre"
            optionValue="id"
            placeholder="Seleccione un estado"
            [loading]="loadingEstados"
            [style]="{'width':'100%'}"
          >
          </p-dropdown>
        </div>
      </div>

      <div class="form-group mt-4 metodo-pago-container" #metodoPagoContainer>
        <div class="flex items-center justify-between mb-2">
          <label class="form-label">Métodos de Pago</label>
          <button
            pButton
            type="button"
            icon="pi pi-plus"
            label="Agregar Método"
            class="p-button-sm p-button-outlined"
            (click)="agregarMetodoPago()"
            [disabled]="!metodoPagoTemporal"
          ></button>
        </div>

        <p-dropdown
          #metodoPagoDropdown
          [(ngModel)]="metodoPagoTemporal"
          [options]="getMetodosPagoDisponibles()"
          optionLabel="nombre"
          placeholder="Seleccione un método de pago"
          [loading]="loadingMetodosPago"
          [style]="{'width':'100%'}"
          appendTo="body"
          panelStyleClass="metodo-pago-dropdown-panel"
          (onShow)="onMetodoPagoDropdownShow(metodoPagoContainer)"
        >
          <ng-template let-metodo pTemplate="item">
            <div class="flex flex-col gap-1">
              <span class="font-medium">{{ metodo.nombre }}</span>
              @if (metodo.comision_porcentaje) {
                <span class="text-xs text-gray-500">{{ metodo.comision_porcentaje }}%</span>
              }
            </div>
          </ng-template>
          <ng-template let-metodo pTemplate="selectedItem">
            <span>{{ metodo?.nombre }}</span>
          </ng-template>
        </p-dropdown>

        @if (metodosPagoSeleccionados.length > 0) {
          <div class="mt-4 bg-white rounded-lg border border-gray-200 overflow-hidden">
            <p-table
              [value]="metodosPagoSeleccionados"
              [paginator]="false"
              styleClass="p-datatable-gridlines"
            >
              <ng-template pTemplate="header">
                <tr>
                  <th>Método de Pago</th>
                  <th style="width: 200px" class="text-right">Monto</th>
                  <th style="width: 80px" class="text-center">Acciones</th>
                </tr>
              </ng-template>

              <ng-template pTemplate="body" let-metodoPago>
                <tr>
                  <td class="font-medium">
                    <div class="flex flex-col gap-1">
                      <span>{{ metodoPago.metodoPago.nombre }}</span>
                      @if (metodoPago.metodoPago.comision_porcentaje) {
                        <span class="text-xs text-gray-500">{{ metodoPago.metodoPago.comision_porcentaje }}%</span>
                      }
                    </div>
                  </td>
                  <td>
                    <input
                      type="number"
                      [(ngModel)]="metodoPago.monto"
                      [min]="0"
                      [max]="calcularTotal()"
                      class="w-full"
                    />
                  </td>
                  <td class="text-center">
                    <button
                      pButton
                      type="button"
                      icon="pi pi-trash"
                      class="p-button-rounded p-button-text p-button-danger p-button-sm"
                      (click)="eliminarMetodoPago(metodoPago.id)"
                      pTooltip="Eliminar método de pago"
                      tooltipPosition="top"
                    ></button>
                  </td>
                </tr>
              </ng-template>
            </p-table>
          </div>
        }
      </div>

      <div class="form-group mt-4">
        <label class="form-label">Fecha de Pedido *</label>
        <p-calendar
          appendTo="body"
          [(ngModel)]="nuevaVenta.fechaPedido"
          [disabled]="fechaPedidoDisabled"
          [showIcon]="true"
          dateFormat="dd/mm/yy"
          placeholder="Seleccione una fecha"
          [style]="{'width':'100%'}"
        >
        </p-calendar>
        <div class="mt-2">
          <p-checkbox
            [(ngModel)]="fueHoy"
            (ngModelChange)="onFueHoyChange()"
            inputId="fueHoy"
            [binary]="true"
          >
          </p-checkbox>
          <label for="fueHoy" class="ml-2 text-sm text-gray-700 cursor-pointer">
            Fue hoy
          </label>
        </div>
      </div>

      <div class="form-group mt-4">
        <label class="form-label">Dirección del Cliente</label>
        <textarea
          pInputText
          [(ngModel)]="nuevaVenta.direccionCliente"
          (input)="onNotasInput($event)"
          placeholder="Agregar la dirección del cliente..."
          class="w-full auto-resize-textarea"
          rows="3"
        ></textarea>
      </div>

      <div class="form-group mt-2">
        <label class="form-label">Notas</label>
        <textarea
          pInputText
          [(ngModel)]="nuevaVenta.notas"
          (input)="onNotasInput($event)"
          placeholder="Agregar notas adicionales sobre el pedido..."
          class="w-full auto-resize-textarea"
          rows="3"
        ></textarea>
      </div>
    </div>

        <!-- Envío -->
        <div class="section mb-6">
          <div class="form-group">
            <p-checkbox
              [(ngModel)]="necesitaEnvio"
              inputId="necesitaEnvio"
              [binary]="true"
            >
            </p-checkbox>
            <label for="necesitaEnvio" class="ml-2 text-sm text-gray-700 cursor-pointer">
              Necesita envío
            </label>
          </div>

          @if (necesitaEnvio) {
            <div class="form-group mt-4">
              <label class="form-label">Tipo de Envío</label>
              <p-dropdown
                [(ngModel)]="tipoEnvio"
                [options]="tiposEnvio"
                optionLabel="nombre"
                placeholder="Seleccione un tipo de envío"
                [loading]="loadingTiposEnvio"
                [style]="{'width':'100%'}"
                appendTo="body"
              >
                <ng-template let-tipo pTemplate="item">
                  <div class="flex flex-col gap-1">
                    <span class="font-medium">{{ tipo.nombre }}</span>
                    @if (tipo.costo_base !== null) {
                      <span class="text-xs text-gray-500">
                        {{ formatCurrency(tipo.costo_base) }}
                        @if (!tipo.es_costo_fijo) {
                          <span class="text-gray-400">(variable)</span>
                        }
                      </span>
                    }
                    @if (tipo.descripcion) {
                      <span class="text-xs text-gray-400">{{ tipo.descripcion }}</span>
                    }
                  </div>
                </ng-template>
                <ng-template let-tipo pTemplate="selectedItem">
                  <span>{{ tipo?.nombre }}</span>
                </ng-template>
              </p-dropdown>
            </div>

            @if (tipoEnvio?.id === 1) {
              <div class="form-group mt-4">
                <label class="form-label">Cantidad de Envío *</label>
                <p-inputNumber
                  [(ngModel)]="cantidadEnvio"
                  [min]="0"
                  [max]="999999"
                  [style]="{'width':'100%'}"
                  [showButtons]="true"
                  buttonLayout="horizontal"
                  placeholder="Ingrese la cantidad de envío"
                ></p-inputNumber>
              </div>
            }
          }
        </div>

    <!-- Detalles del Pedido -->
    <div class="section mb-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="section-title text-sm font-semibold text-gray-500 uppercase tracking-wider">
          DETALLES DEL PEDIDO
        </h3>
        <button
          pButton
          type="button"
          icon="pi pi-plus"
          label="Agregar Producto"
          class="p-button-success p-button-sm"
          (click)="showSeleccionarProductosModal()"
        ></button>
      </div>

      <div class="table-container-detalles bg-white rounded-lg border border-gray-200">
        <p-table
          [value]="detallesPedido"
          [paginator]="false"
          styleClass="p-datatable-gridlines"
        >
          <ng-template pTemplate="header">
            <tr>
              <th style="width: 80px">Imagen</th>
              <th>Producto</th>
              <th style="width: 100px" class="text-center">Cantidad</th>
              <th style="width: 150px" class="text-right">Precio Venta</th>
              <th style="width: 90px" class="text-right">Descuento</th>
              <th style="width: 150px" class="text-right">Subtotal</th>
              <th style="width: 80px" class="text-center">Acciones</th>
            </tr>
          </ng-template>

          <ng-template pTemplate="body" let-detalle>
            <tr>
              <!-- Imagen -->
              <td>
                <p-image
                  [src]="detalle.imagen"
                  [preview]="true"
                  [alt]="detalle.producto"
                  width="60"
                  height="60"
                  styleClass="product-image-preview"
                  [style]="{ 'object-fit': 'cover', 'border-radius': '4px' }"
                >
                </p-image>
              </td>

              <!-- Producto -->
              <td class="font-medium">{{ detalle.producto }}</td>

              <!-- Cantidad -->
              <td class="text-center font-semibold">
                {{ detalle.cantidad }}
              </td>

              <!-- Precio Venta -->
              <td class="text-right font-mono font-semibold">
                {{ formatCurrency(detalle.precio) }}
              </td>

              <!-- Descuento -->
              <td class="text-right">
                <p-inputNumber
                  [(ngModel)]="detalle.descuento"
                  [min]="0"
                  [max]="detalle.precio * detalle.cantidad"
                  [style]="{'width':'90px', 'max-width':'90px'}"
                  [showButtons]="false"
                  placeholder="0.00"
                  [inputStyle]="{'text-align': 'right', 'padding': '0.25rem 0.5rem', 'width': '90px'}"
                ></p-inputNumber>
              </td>

              <!-- Subtotal -->
              <td class="text-right font-mono font-bold">
                {{ formatCurrency(calcularSubtotalIndividual(detalle)) }}
              </td>

              <!-- Acciones -->
              <td class="text-center">
                <button
                  pButton
                  type="button"
                  icon="pi pi-trash"
                  class="p-button-rounded p-button-text p-button-danger p-button-sm"
                  (click)="eliminarDetallePedido(detalle.id)"
                  pTooltip="Eliminar producto"
                  tooltipPosition="top"
                ></button>
              </td>
            </tr>
          </ng-template>

          <ng-template pTemplate="emptymessage">
            <tr>
              <td colspan="7" class="text-center py-8">
                <i class="pi pi-inbox text-4xl text-gray-400 mb-3 block"></i>
                <p class="text-gray-500">No hay productos agregados</p>
                <p class="text-sm text-gray-400 mt-2">Haz clic en "Agregar Producto" para comenzar</p>
              </td>
            </tr>
          </ng-template>

        </p-table>

        @if (detallesPedido.length > 0) {
          <div class="total-summary bg-gray-50 border-t-2 border-gray-200 px-4 py-3">
            <div class="flex flex-col items-end gap-2">
              <div class="flex items-center gap-4">
                <span class="font-semibold text-gray-700 text-sm">Subtotal:</span>
                <span class="font-mono font-semibold text-base text-gray-900">
                  {{ formatCurrency(calcularSubtotal()) }}
                </span>
              </div>
              <div class="flex items-center gap-4">
                <span class="font-semibold text-gray-700 text-sm">IVA (15%):</span>
                <span class="font-mono font-semibold text-base text-gray-900">
                  {{ formatCurrency(calcularIVA()) }}
                </span>
              </div>
              <div class="flex items-center gap-4 pt-2 border-t border-gray-300">
                <span class="font-semibold text-gray-900 text-base">Total:</span>
                <span class="font-mono font-bold text-xl text-gray-900">
                  {{ formatCurrency(calcularTotal()) }}
                </span>
              </div>
              @if (esEfectivoUnico() && calcularVuelto() > 0) {
                <div class="flex items-center gap-4 pt-2">
                  <span class="font-semibold text-green-600 text-base">Vuelto:</span>
                  <span class="font-mono font-bold text-lg text-green-600">
                    {{ formatCurrency(calcularVuelto()) }}
                  </span>
                </div>
              }
            </div>
          </div>
        }
      </div>
    </div>

    <div class="form-group">
      <p-checkbox
        [(ngModel)]="ignorarISV"
        inputId="ignorarISV"
        [binary]="true"
      >
      </p-checkbox>
      <label for="ignorarISV" class="ml-2 text-sm text-gray-700 cursor-pointer">
        ¿Ignorar ISV?
      </label>
    </div>

    <!-- Botones de Acción -->
    <div class="modal-footer flex justify-end gap-3 pt-4 border-t border-gray-200">
      <button
        pButton
        type="button"
        label="Cancelar"
        class="p-button-text"
        (click)="hideNuevaVentaModal()"
      >
      </button>
      <button
        pButton
        type="button"
        label="Guardar Venta"
        class="p-button-primary"
        (click)="guardarVenta()"
      >
      </button>
    </div>
  </div>
</p-dialog>

<!-- Modal para seleccionar productos -->
<p-dialog
  [(visible)]="displaySeleccionarProductosModal"
  [modal]="true"
  [style]="{ width: '60vw', minWidth: '700px', maxHeight: '90vh' }"
  [breakpoints]="{ '1024px': '85vw', '640px': '95vw' }"
  [draggable]="false"
  [resizable]="false"
  [closable]="true"
  [showHeader]="true"
  header="Seleccionar Productos"
  (onHide)="hideSeleccionarProductosModal()"
>
  <div class="seleccionar-productos-modal">
    <!-- Descripción -->
    <div class="modal-description mb-4">
      <p class="text-sm text-gray-600">Selecciona uno o más productos para agregar al pedido</p>
    </div>

    <!-- MultiSelect de Productos -->
    <div class="form-group mb-4">
      <label class="form-label">Productos *</label>
      <p-multiSelect
        [(ngModel)]="productosSeleccionados"
        (ngModelChange)="onProductosSeleccionadosChange()"
        [options]="productosDisponibles"
        appendTo="body"
        optionLabel="producto"
        placeholder="Seleccione productos"
        [loading]="loadingProductos"
        [style]="{'width':'100%'}"
        [displaySelectedLabel]="true"
        [selectedItemsLabel]="selectedItemsLabel"
        [maxSelectedLabels]="3"
        [showToggleAll]="true"
      >
        <ng-template let-product pTemplate="item">
          <div class="flex items-center gap-3">
            <p-image
              [src]="getProductImageUrl(product)"
              [preview]="false"
              [alt]="product.producto"
              width="40"
              height="40"
              styleClass="product-image-preview-small"
              [style]="{ 'object-fit': 'cover', 'border-radius': '4px' }"
            >
            </p-image>
            <div>
              <div class="font-medium">{{ product.producto }}</div>
              <div class="text-sm text-gray-500">{{ formatCurrency(product.precio) }} | Stock: {{ product.stock }}</div>
            </div>
          </div>
        </ng-template>
      </p-multiSelect>
    </div>

    <!-- Tabla de productos seleccionados con cantidades -->
    @if (productosConCantidad.length > 0) {
      <div class="productos-cantidad-table mb-6">
        <h4 class="text-sm font-semibold text-gray-700 mb-3">Cantidades por producto:</h4>
        <div class="bg-white rounded-lg border border-gray-200 overflow-hidden">
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="text-left p-3 text-xs font-semibold text-gray-600">Producto</th>
                <th class="text-center p-3 text-xs font-semibold text-gray-600">Stock</th>
                <th class="text-center p-3 text-xs font-semibold text-gray-600">Cantidad</th>
              </tr>
            </thead>
            <tbody>
              @for (item of productosConCantidad; track item.producto.id) {
                <tr class="border-t border-gray-200">
                  <td class="p-3 font-medium">{{ item.producto.producto }}</td>
                  <td class="p-3 text-center font-semibold">{{ item.producto.stock }}</td>
                  <td class="p-3 text-center">
                    <p-inputNumber
                      [(ngModel)]="item.cantidad"
                      [min]="1"
                      [max]="item.producto.stock"
                      [style]="{'width': '60px', 'height': '28px'}"
                      [showButtons]="true"
                      buttonLayout="horizontal"
                      [inputStyle]="{'width': '30px', 'height': '28px', 'padding': '2px 4px', 'font-size': '0.75rem', 'text-align': 'center'}"
                    ></p-inputNumber>
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      </div>
    }

    <!-- Botones de Acción -->
    <div class="modal-footer flex justify-end gap-3 pt-4 border-t border-gray-200">
      <button
        pButton
        type="button"
        label="Cancelar"
        class="p-button-text"
        (click)="hideSeleccionarProductosModal()"
      >
      </button>
      <button
        pButton
        type="button"
        label="Finalizar"
        class="p-button-success"
        [disabled]="productosSeleccionados.length === 0"
        (click)="finalizarSeleccionProductos()"
      >
      </button>
    </div>
  </div>
</p-dialog>
